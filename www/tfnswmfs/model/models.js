sap.ui.define([               "sap/ui/model/json/JSONModel",               "sap/ui/Device"               ], function(JSONModel, Device) {	"use strict";	var	_sAppModulePath = "tfnswmfs/";	return {		createDeviceModel: function() {			var oModel = new JSONModel(Device);			oModel.setDefaultBindingMode("OneWay");			return oModel;		},		createValueHelpModel:function(){			var ValueHelp = {					"fromView": "",					"searchField": "",					"setNo": "",					"carNo": ""			};			var oModel = new sap.ui.model.json.JSONModel();			oModel.setData(ValueHelp);			return oModel;		},		mainDataModel:function(){			var sServerUrl = applicationContext.applicationEndpointURL + "/ZGWP_PM_MOBILE_FMS_SRV/";			var mainModel = new sap.ui.model.odata.ODataModel(sServerUrl,true);//			mainModel.oHeaders = {"sap-client" :"110"};			return mainModel;		},		getPopOverModel: function(vController, entitySet, modelName){			var mainDataModel = this.mainDataModel();			var oModel = new sap.ui.model.json.JSONModel();			mainDataModel.read(entitySet, {				success: function(data, response) {					if(modelName === "priorityModel"){						for(var i=0;i<data.results.length;i++){ if(data.results[i].Zzpriok === "U") data.results.splice(i)}					}else if(modelName === "weatherModel"){						for(var i=0;i<data.results.length;i++){ 							if(data.results[i].Zzweather === "F"){								data.results[i].sortId = "1";							}else if(data.results[i].Zzweather === "L"){								data.results[i].sortId = "2";							}else if(data.results[i].Zzweather === "H"){								data.results[i].sortId = "3";							}						}					}else if (modelName === "temperatureModel"){						for(var i=0;i<data.results.length;i++){ 							if(data.results[i].Zztemp === "C"){								data.results[i].sortId = "1";							}else if(data.results[i].Zztemp === "A"){								data.results[i].sortId = "2";							}else if(data.results[i].Zztemp === "H"){								data.results[i].sortId = "3";							}else{								data.results[i].sortId = "4";							}						}					}					oModel.setData({						listitems: data.results					});					vController.getView().setModel(oModel, modelName);									},				error: function(oError) {					vController.getView().setModel(oModel, modelName);									/*do nothing yet return empty model*/				}			});		},		getTechniciansModel: function(vController, entitySet, modelName){			var mainDataModel = this.mainDataModel();			var oModel = new sap.ui.model.json.JSONModel();			mainDataModel.read(entitySet, {				success: function(data, response) {					if(modelName === "priorityModel"){						for(var i=0;i<data.results.length;i++){ if(data.results[i].Zzpriok === "U") data.results.splice(i)}					}					oModel.setData({						listitems: data.results					});					vController.setModel(oModel, modelName);					vController.getModel(modelName).refresh();				},				error: function(oError) {					vController.getView().setModel(oModel, modelName);									/*do nothing yet return empty model*/				}			});		},		getPopOverModelWQFilter: function(vController, entitySet,filter, modelName){			var mainDataModel = this.mainDataModel();			var oModel = new sap.ui.model.json.JSONModel();			mainDataModel.read(entitySet+filter, {				success: function(data, response) {					if(modelName === "positionModel"){						data.results.forEach(function(itm) {							if(itm.Zzdesc === "N/A"){								itm.Zzcode = "NULL";							}						});					}					oModel.setData({						listitems: data.results					});					vController.getView().setModel(oModel, modelName);					},				error: function(oError) {					vController.getView().setModel(oModel, modelName);					/*do nothing yet return empty model*/				}			});		},		getSubSystemModel: function(vController, entitySet,filter, modelName){			var mainDataModel = this.mainDataModel();			var oModel = new sap.ui.model.json.JSONModel();			mainDataModel.read(entitySet+filter, {				success: function(data, response) {										oModel.setData({						listitems: data.results,						singleFlag: (data.results[0].SubSystem !== "" ? true : false),						multiFlag: (data.results[0].SubSystem !== "" ? false : true),						groups:  vController.getSubSystemGroups(data.results),						codes: vController.getSubSystemCodes(vController,data.results,"")					});					vController.getView().setModel(oModel, modelName);					},				error: function(oError) {					vController.getView().setModel(oModel, modelName);					/*do nothing yet return empty model*/				}			});		},				initWarningMsg:function(vController,msgField){			var mainDataModel = this.mainDataModel();			var initMessage = "";			mainDataModel.read("/ETS_WELCOME_TEXT", {				success: function(data, response) {					for(var i=0;i<data.results.length;i++){						if(data.results[i].Text === "INFO")							initMessage += data.results[i].Tdline+" \n";					}//					initMessage.replace("\n", "<br>");					msgField.setText(initMessage);									},				error: function(oError) {					msgField.setText("");				}			});							},		initInfoMsg:function(vController){			var mainDataModel = this.mainDataModel();			var lineNo = "";			mainDataModel.read("/ETS_WELCOME_TEXT", {				success: function(data, response) {					for(var i=0;i<data.results.length;i++){						if(data.results[i].Text === "MESS"){							lineNo = "line"+data.results[i].Tabix;							vController.getView().byId(lineNo).setText(data.results[i].Tdline);						}					}									},				error: function(oError) {//					console.log("well do nothing here yet");				}			});							},		setTripId:function(vController,qryFilter, field,mFSMsg){			var vModel = this;			if(!vModel.busyIndicator){				vModel.busyIndicator = new sap.m.BusyDialog()			}			vModel.busyIndicator.open();			var mainDataModel = this.mainDataModel();			mainDataModel.read("ETS_TRIP_DETAILS"+qryFilter, {				success: function(data, response) {					var tripId = data.results[0].IvTripid;					var msg = (tripId !== "" ? mFSMsg.getProperty("tripIdFound")+tripId : mFSMsg.getProperty("tripIdNotFound"));					vModel.busyIndicator.close();										sap.m.MessageBox.show(msg,{						icon: mFSMsg.getProperty("popInfo"), 						title: mFSMsg.getProperty("popTitleInfo"), 						actions: sap.m.MessageBox.Action.OK, 						onClose: function() { 							if(tripId !== ""){								vController.getView().getModel("faultModel").oData.Tripnum = tripId;								vController.getView().byId(field).setValue(tripId);							}						}					});//					vController.getView().getModel("faultModel").oData.Tripnum = data.results[0].IvTripid;//					vController.getView().byId(field).setValue(data.results[0].IvTripid);				},				error: function(oError) {					vModel.busyIndicator.close();//					vController.getView().getModel("faultModel").oData.Tripnum = "";//					vController.getView().byId(field).setValue("");					sap.m.MessageBox.show(oError.message,{						icon: mFSMsg.getProperty("popError"), 						title: mFSMsg.getProperty("popTitleError"), 						actions: sap.m.MessageBox.Action.OK, 						onClose: function() {/* do nothing*/ }					});				}			});							},		searchOpenFaultsByFilter:function(vController, setNo,carNo,mjrSys,selSubSystem,sapFlag){			var subSys = ((selSubSystem.SubSystem && selSubSystem.SubSystem !== "") ? selSubSystem.SubSystem : "");			var objCode = ((selSubSystem.ObjectCode && selSubSystem.ObjectCode !== "") ? selSubSystem.ObjectCode : "");			var objCodeGrp = ((selSubSystem.ObjectCodeGroup && selSubSystem.ObjectCodeGroup !== "") ? selSubSystem.ObjectCodeGroup : "");			var vModel = this;			if(!vModel.busyIndicator){				vModel.busyIndicator = new sap.m.BusyDialog()			}			vModel.busyIndicator.open();			var filters 		= [];			if(setNo !== ""){				filters.push(new sap.ui.model.Filter("Setid", sap.ui.model.FilterOperator.EQ, setNo));			}			if(carNo !== ""){				filters.push(new sap.ui.model.Filter("Carid", sap.ui.model.FilterOperator.EQ, carNo));			}			if(mjrSys !== "" && sapFlag){				filters.push(new sap.ui.model.Filter("MajorSystem", sap.ui.model.FilterOperator.EQ, mjrSys));			}			if(subSys !== "" && sapFlag){				filters.push(new sap.ui.model.Filter("SubSystem", sap.ui.model.FilterOperator.EQ, subSys));			}			if(objCode !== "" && sapFlag){				filters.push(new sap.ui.model.Filter("ObjectCode", sap.ui.model.FilterOperator.EQ, objCode));			}			if(objCodeGrp !== "" && sapFlag){				filters.push(new sap.ui.model.Filter("ObjectCodeGroup", sap.ui.model.FilterOperator.EQ, objCodeGrp));			}			filters.push(new sap.ui.model.Filter("FaultUserStat", sap.ui.model.FilterOperator.EQ, "1"));							var mainDataModel = this.mainDataModel();			var openFaultsModel = new sap.ui.model.json.JSONModel();			if(vController.getView().getModel("openFaultsModel")){				vController.getView().getModel("openFaultsModel").oData.listitems = [];			}			mainDataModel.read("ETS_FAULT",{				success: function(data, response) {					if(!sapFlag){						openFaultsModel.setData({							listitems: vModel.filterFaultsList(data.results,mjrSys,subSys)						});					}else{						openFaultsModel.setData({							listitems: data.results						});					}					var openCount = "Search Result : "+openFaultsModel.oData.listitems.length;					openFaultsModel.setSizeLimit(openFaultsModel.oData.listitems.length);//					vController.getView().byId();					vController.getView().setModel(openFaultsModel, "openFaultsModel");					vController.getView().byId("openCount").setText(openCount);//					vController.getView().byId("tableOpenFault").setVisible(true);//					vController.tableButtonToggle(vController,true);					if(openFaultsModel.oData.listitems.length > 0){						vController.getView().byId("tableOpenFault").setVisible(true);						vController.tableButtonToggle(vController,true);						vController.getView().byId("toggleButtonSpacer").setWidth("5px");											}else{						vController.getView().byId("tableOpenFault").setVisible(false);						vController.tableButtonToggle(vController,false);						vController.getView().byId("list_expand").setVisible(false);						vController.getView().byId("list_collapse").setVisible(false);						vController.getView().byId("toggleButtonSpacer").setWidth("30px");					}					vModel.busyIndicator.close();				},				error: function(oError) {					openFaultsModel.setData({						listitems: {}					});					vController.getView().byId("openCount").setText("Seacrh Result : 0");					vController.getView().setModel(openFaultsModel, "openFaultsModel");					vController.getView().byId("tableOpenFault").setVisible(false);					vModel.busyIndicator.close();				},				filters: filters			});		}, 		filterFaultsList:function(results, mjrSys, subSys){			var mFlag = false;			var sFlag = false;			var okMFlag = false;			var okSFlag = false;			var cleaned = [];			var checkValue = "";			var checkFlag = true;						mjrSys = (mjrSys ? mjrSys : "");			subSys = (subSys ? subSys : "");						if(mjrSys !== "" & subSys !== ""){				checkValue = subSys.substr(0, 2);				checkFlag = true;			}else if(mjrSys !== "" & subSys === ""){				checkValue = mjrSys.substr(0, 1);				checkFlag = true;			}else if(mjrSys === "" & subSys === ""){				checkValue = "";				checkFlag = false;			}			if(checkFlag){				results.forEach(function(itm) {					if(itm.MajorSystem.substr(0, checkValue.length) === checkValue){						cleaned.push(itm);					}				});				return cleaned;			}else{				return results;			}					},		checkSetInSAPnGetMjrSystem:function(vController,carId, carEgi){			var vModel = this;			if(!vModel.busyIndicator){				vModel.busyIndicator = new sap.m.BusyDialog()			}			vModel.busyIndicator.open();			var mainDataModel = this.mainDataModel();			var setId = vController.initData.setId//initModel.oData.setId;			if(setId && setId !== ""){				mainDataModel.read("ETS_SET_CHECK(SetId='"+setId+"')?$format=json",{					success: function(data, response) {						vController.initData.set_car_sap = data.SetPresent;				//						vController.getView().byId("setorCar").setEnabled(false);						vController.getView().byId("carSelectButtons").setVisible(false);						vController.getView().byId("searchSetorCarButton").setVisible(false);						vController.getView().byId("faultSubmitButton").setEnabled(true);						vController.getView().byId("carsContainer").setVisible(false);							vController.toggleSearchFieldRows(true);						vController.getView().byId("list_expand").setVisible(false);						vController.getView().byId("list_collapse").setVisible(true);						var qryFilter = "";						if(data.SetPresent){							qryFilter ="?$filter=SetId eq '"+data.SetId+"' and Zzcarid eq '"+carId+"' and Zzcar_egi eq '' &$format=json";						}else{							qryFilter ="?$filter=SetId eq '"+data.SetId+"' and Zzcarid eq '"+carId+"' and Zzcar_egi eq '"+carEgi+"' &$format=json";						}						if(sap.ui.getCore().byId("majorSystemList")){							sap.ui.getCore().byId("majorSystemList").removeAllItems();						}						vModel.getPopOverModelWQFilter(vController,'ETS_MAJOR_SYSTEM',qryFilter,"majorSystemModel");						vModel.searchOpenFaultsByFilter(vController,setId, carId,"","",true);						vModel.busyIndicator.close();					},					error: function(oError) {						vController.initData.set_car_sap = false;						vModel.busyIndicator.close();					},				},false);							}else{				vController.initData.set_car_sap = false;				vModel.busyIndicator.close();			}		},		checkSetInSAP:function(vController){			var vModel = this;			if(!vModel.busyIndicator){				vModel.busyIndicator = new sap.m.BusyDialog()			}			vModel.busyIndicator.open();			var mainDataModel = this.mainDataModel();			var setId = vController.initData.setId;			if(setId && setId !== ""){				mainDataModel.read("ETS_SET_CHECK(SetId='"+setId+"')?$format=json",{					success: function(data, response) {						vController.initData.set_car_sap = data.SetPresent;						if(vController.getView().byId("technicianAssignmentBlock")){							vController.getView().byId("technicianAssignmentBlock").setVisible(data.SetPresent);						}						var initModel =  new sap.ui.model.json.JSONModel();						initModel.setData(vController.initData);						vController.getView().setModel(initModel,"initModel");						vModel.busyIndicator.close();					},					error: function(oError) {						vController.initData.set_car_sap = false;						vModel.busyIndicator.close();					},				},false);							}else{				vController.initData.set_car_sap = false;				vModel.busyIndicator.close();			}		},		checkSetInSAPforCRT:function(vController,carModel){			var vModel = this;			if(!vModel.busyIndicator){				vModel.busyIndicator = new sap.m.BusyDialog()			}			vModel.busyIndicator.open();			var mainDataModel = this.mainDataModel();			var setId = vController.initData.setId;//initModel.oData.setId;			if(setId && setId !== ""){				mainDataModel.read("ETS_SET_CHECK(SetId='"+setId+"')?$format=json",{					success: function(data, response) {						vController.initData.set_car_sap = data.SetPresent;							vController.loadCarsFragment(carModel,vController);							vController.getView().byId("carSelectButtons").setVisible(true);							vController.getView().byId("searchSetorCarButton").setVisible(false);							vController.getView().byId("car_select_confirm").setVisible(false);							vController.getView().byId("faultSubmitButton").setEnabled(false);							vController.getView().byId("carsContainer").setVisible(true);							vController.getView().byId("car_select_all").setEnabled(true);							vController.getView().byId("car_dSelect_all").setEnabled(true);							vController.toggleSearchFieldRows(false);							vController.getView().byId("faultSourceRow").setDefaultSpan("L12 M12 S12");//							vController.getView().byId("setorCar").setEnabled(false);						vModel.busyIndicator.close();					},					error: function(oError) {						vController.initData.set_car_sap = false;						vModel.busyIndicator.close();					},				},false);							}else{				vController.initData.set_car_sap = false;				vModel.busyIndicator.close();			}		},		postNotification:function(vController, data,mFSMsg,router,toView){			if(!this.busyIndicator){				this.busyIndicator = new sap.m.BusyDialog()			}			var modal = this;			var oModel =  new sap.ui.model.odata.ODataModel(this.mainDataModel().sServiceUrl, true)			modal.busyIndicator.open();			oModel.refreshSecurityToken( function(a, b) {				oModel.oHeaders = {						"x-csrf-token" : b.headers["x-csrf-token"],						"Content-Type" : "application/json; charset=utf-8"};				var formattedData = {"d":data};				oModel.create('/ETS_FAULT',formattedData,{					success : function(data, response){						modal.busyIndicator.close();						vController.showMSGDialog(vController,data, response,toView);					},					error : function(error){						modal.busyIndicator.close();						sap.m.MessageBox.show(JSON.parse(error.response.body).error.message.value,{							icon: mFSMsg.getProperty("popError"), 							title: mFSMsg.getProperty("popTitle"), 							actions: [sap.m.MessageBox.Action.OK], 							onClose: function(oAction){								if(oAction === sap.m.MessageBox.Action.OK){									//for now do nothing and leave it in the same screen								}							}						});					}				});			}, function(a) {			}, true);		},		syncDocument:function(vController, faultId,mFSMsg){			if(!this.busyIndicator){				this.busyIndicator = new sap.m.BusyDialog()			}			var modal = this;			var oModel =  new sap.ui.model.odata.ODataModel(this.mainDataModel().sServiceUrl, true);			var data = {					"IvQmnum" : faultId			}			modal.busyIndicator.open();			oModel.refreshSecurityToken( function(a, b) {				oModel.oHeaders = {						"x-csrf-token" : b.headers["x-csrf-token"],						"Content-Type" : "application/json; charset=utf-8"};				var formattedData = {"d":data};				oModel.create('/ETS_AWSSYNC_SERVICE',formattedData,{					success : function(data, response){						modal.busyIndicator.close();						sap.m.MessageBox.show(mFSMsg.getProperty("fileLoaded"),{							icon: mFSMsg.getProperty("popSuccess"), 							title: mFSMsg.getProperty("popTitleSuccess"), 							actions: [sap.m.MessageBox.Action.OK], 							onClose: function(oAction){								if(oAction === sap.m.MessageBox.Action.OK){									vController.getAWSAttachments(vController,faultId);								}							}						});					},					error : function(error){						modal.busyIndicator.close();						sap.m.MessageBox.show(mFSMsg.getProperty("fileUploadFail"),{							icon: mFSMsg.getProperty("popError"), 							title: mFSMsg.getProperty("popTitle"), 							actions: [sap.m.MessageBox.Action.OK], 							onClose: function(oAction){								if(oAction === sap.m.MessageBox.Action.OK){									//for now do nothing and leave it in the same screen								}							}						});					}				});			}, function(a) {			}, true);		},		getAmazonAWSServerDateString:function(){			var URL            = "http://s3.amazonaws.com" ;			var awsDataModel = new sap.ui.model.odata.ODataModel(URL);//			var res = awsDataModel.loadData(URL,false);			awsDataModel.oHeaders = {"HEAD" : ""};			awsDataModel.read("", {				success: function(data, response) {					console.log("data "+data);								},				error: function(oError) {					console.log("oError "+oError);					}			});		},		getWeatherServiceData:function( latitude,longitude){			var accessKey="463448ca19ce4acbb3043212162403";			var url = "http://api.worldweatheronline.com/premium/v1/weather.ashx";			var params = "key="+accessKey+"&q="+latitude+","+longitude+"&format=json&num_of_days=1&lang=EN";			var weatherDataModel = new sap.ui.model.json.JSONModel();			weatherDataModel.loadData(url, params, false);			return weatherDataModel.oData.data.current_condition;		},		getEmptyFaultStructure:function(){			var oData = {					"AuditNum":"",					"AuditType":"",					"AuditTypeDesc":"",					"CarDesc":"",					"Carid":"",					"EngFlag":"",					"EngFlagDesc":"",					"FaultComment":"",					"FaultDate":null,					"FaultLocDesc":"",					"FaultLocation":"",					"FaultSource":"",					"FaultSrcDesc":"",					"FaultSysStat":"",					"FaultTime":null,					"FaultUserStat":"",					"FctoDesc":"",					"FfdcDesc":"",					"FftrDesc":"",					"FnbfDesc":"",					"Longtext":"",					"MajorSystem":"",					"Message":"",					"MjrsysDesc":"",					"MsgType":"",					"NAV_FAULT_CAR":"",					"Position":"",					"PositionDesc":"",					"Primedupflag":"",					"Primefaultnum":"",					"Priority":"",					"PriorityDesc":"",					"Qmcod":"",					"QmcodDesc":"",					"Qmdat":null,					"Qmgrp":"",					"QmgrpDesc":"",					"Qmnum":"",					"Qmtxt":"",					"ReasonPrio":"",					"RepPhaseDesc":"",					"ReportPhase":"",					"SetDesc":"",					"Setid":"",					"SrchFromDate":null,					"SrchToDate":null,					"SubSystem":"",					"SubsysDesc":"",					"SysStatDesc":"",					"TempDesc":"",					"Temperature":"",					"Tripnum":"",					"Weather":"",					"WeatherDesc":"",					"WorkAction":"",					"WorkFound":""			}			return oData;		},	};});